# ---- ì¤‘ìš”: Teachable Machine ëª¨ë¸ groups ë¬¸ì œ íŒ¨ì¹˜ ----
import tensorflow as tf
from tensorflow import keras

class PatchedDepthwiseConv2D(keras.layers.DepthwiseConv2D):
    def __init__(self, *args, groups=1, **kwargs):
        super().__init__(*args, **kwargs)

# ------------------------------------------------------

from keras.models import load_model
from PIL import Image, ImageOps
import numpy as np

np.set_printoptions(suppress=True)

# ëª¨ë¸ ë¡œë“œ
model = load_model(
    "keras_model.h5",
    compile=False,
    custom_objects={"DepthwiseConv2D": PatchedDepthwiseConv2D}
)

# ë¼ë²¨ ë¡œë“œ
class_names = open("labels.txt", "r").readlines()

# ì…ë ¥ ë°°ì—´ ì¤€ë¹„
data = np.ndarray(shape=(1, 224, 224, 3), dtype=np.float32)

# ì´ë¯¸ì§€ íŒŒì¼ ë¡œë“œ
image = Image.open("photo.jpg").convert("RGB")

size = (224, 224)
image = ImageOps.fit(image, size, Image.Resampling.LANCZOS)

image_array = np.asarray(image)
normalized_image_array = (image_array.astype(np.float32) / 127.5) - 1
data[0] = normalized_image_array

# ì˜ˆì¸¡
prediction = model.predict(data)
index = np.argmax(prediction)    # â† ì˜ˆì¸¡ëœ í´ë˜ìŠ¤ ë²ˆí˜¸ (0,1,2,...)
confidence_score = prediction[0][index]
class_name = class_names[index].strip()

print("Class:", class_name)
print("Confidence Score:", confidence_score)

# --------------------------
# ğŸ”¥ ì¡°ê±´ë¬¸ ì¶œë ¥ ê¸°ëŠ¥ ì¶”ê°€
# --------------------------

if index == 0:
    print("ì•ˆë…•")
elif index == 1:
    print("ë°˜ê°€ì›Œ")
elif index == 2:
    print("ì¢‹ì€ í•˜ë£¨ì•¼!")
else:
    print("ì•Œ ìˆ˜ ì—†ëŠ” í´ë˜ìŠ¤ì…ë‹ˆë‹¤.")
